PRAGMA foreign_keys = ON;

--users
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  gender TEXT NOT NULL,
  first_name TEXT NOT NULL,
  last_name TEXT NOT NULL,
  password TEXT NOT NULL,
  email TEXT UNIQUE NOT NULL,
  phone TEXT DEFAULT NULL,
  address TEXT DEFAULT NULL,
  postal_code TEXT DEFAULT NULL,
  city TEXT DEFAULT NULL,
  state TEXT DEFAULT NULL,
  country TEXT DEFAULT 'Deutschland',
  website TEXT DEFAULT NULL,

  company_name TEXT DEFAULT NULL,
  company_details TEXT DEFAULT '{}',
  company_signature TEXT DEFAULT NULL,
  contact_person TEXT DEFAULT '{}',

  tax_number TEXT DEFAULT NULL,
  tax_office TEXT DEFAULT NULL,
  vat_id TEXT DEFAULT NULL,
  court_registration TEXT DEFAULT NULL,
  court_location TEXT DEFAULT NULL,

  logo BLOB DEFAULT NULL,
  image_type TEXT DEFAULT NULL,

  bank_name TEXT DEFAULT NULL,
  bic TEXT DEFAULT NULL,
  iban TEXT DEFAULT NULL,
  bank_account_holder TEXT DEFAULT NULL,

  invoice_approved INTEGER NOT NULL DEFAULT 0,

  created_at DATETIME DEFAULT (datetime('now')),
  updated_at DATETIME DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_users_email ON users(email);

CREATE TRIGGER IF NOT EXISTS trg_users_updated_at
AFTER UPDATE ON users
BEGIN
  UPDATE users SET updated_at = datetime('now') WHERE id = NEW.id;
END;


--tokens
CREATE TABLE IF NOT EXISTS tokens (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  token TEXT UNIQUE NOT NULL,
  user_id INTEGER NOT NULL,
  expires_at DATETIME NOT NULL,
  created_at DATETIME DEFAULT (datetime('now')),
  FOREIGN KEY(user_id) REFERENCES users(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_tokens_user_id ON tokens(user_id);



CREATE TABLE IF NOT EXISTS customers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  is_active INTEGER NOT NULL DEFAULT 1,

  company_type TEXT DEFAULT NULL,
  company_name TEXT DEFAULT NULL,

  first_name TEXT DEFAULT NULL,
  last_name TEXT DEFAULT NULL,
  full_name TEXT GENERATED ALWAYS AS (COALESCE(first_name,'') || ' ' || COALESCE(last_name,'')) VIRTUAL,

  email TEXT DEFAULT NULL,
  phone TEXT DEFAULT NULL,
  website TEXT DEFAULT NULL,
  address TEXT DEFAULT NULL,
  postal_code TEXT DEFAULT NULL,
  city TEXT DEFAULT NULL,
  country TEXT DEFAULT 'Deutschland',

  tax_number TEXT DEFAULT NULL,
  vat_id TEXT DEFAULT NULL,

  created_at DATETIME DEFAULT (datetime('now')),
  updated_at DATETIME DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_customers_full_name ON customers(full_name);

CREATE TRIGGER IF NOT EXISTS trg_customers_updated_at
AFTER UPDATE ON customers
BEGIN
  UPDATE customers SET updated_at = datetime('now') WHERE id = NEW.id;
END;


-- invoices
CREATE TABLE IF NOT EXISTS invoices (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  customer_id INTEGER NOT NULL,
  customer_snapshot TEXT NOT NULL DEFAULT '{}',

  is_active INTEGER NOT NULL DEFAULT 1,

  service_date TEXT NOT NULL,
  date TEXT NOT NULL,
  due_date TEXT DEFAULT NULL,

  currency TEXT NOT NULL DEFAULT 'EUR.de-DE',

  payment_terms INTEGER NOT NULL DEFAULT 14,
  payment_conditions TEXT DEFAULT NULL,

  is_early_payment INTEGER NOT NULL DEFAULT 0,
  early_payment_discount REAL NOT NULL DEFAULT 0,
  early_payment_percentage REAL NOT NULL DEFAULT 0,
  early_payment_days INTEGER NOT NULL DEFAULT 0,
  early_payment_date TEXT DEFAULT NULL,

  is_small_company INTEGER NOT NULL DEFAULT 0,
  is_reverse_charge INTEGER NOT NULL DEFAULT 0,
  is_eu_delivery INTEGER NOT NULL DEFAULT 0,

  positions TEXT NOT NULL DEFAULT '[]',

  net_total REAL NOT NULL DEFAULT 0,
  vat_total REAL NOT NULL DEFAULT 0,
  gross_total REAL NOT NULL DEFAULT 0,
  gross_total_after_discount REAL NOT NULL DEFAULT 0,

  payment_status TEXT NOT NULL DEFAULT 'unpaid',
  CHECK (payment_status IN ('unpaid','partially_paid','paid')),

  cancelled_at TEXT DEFAULT NULL,
  cancelled_by TEXT DEFAULT NULL,
  cancellation_reason TEXT DEFAULT NULL,

  created_at DATETIME DEFAULT (datetime('now')),
  updated_at DATETIME DEFAULT (datetime('now')),

  FOREIGN KEY(customer_id) REFERENCES customers(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_invoices_customer_id ON invoices(customer_id);
CREATE INDEX IF NOT EXISTS idx_invoices_date ON invoices(date);

CREATE TRIGGER IF NOT EXISTS trg_invoices_updated_at
AFTER UPDATE ON invoices
BEGIN
  UPDATE invoices SET updated_at = datetime('now') WHERE id = NEW.id;
END;


-- payments
CREATE TABLE IF NOT EXISTS payments (
  id INTEGER PRIMARY KEY AUTOINCREMENT,

  invoice_id INTEGER NOT NULL,
  customer_id INTEGER NOT NULL,

  invoice_snapshot TEXT NOT NULL DEFAULT '{}',
  payment_date TEXT NOT NULL,
  payment_amount REAL NOT NULL DEFAULT 0,
  payment_method TEXT DEFAULT NULL,
  payment_reference TEXT DEFAULT NULL,

  counterparty_name TEXT DEFAULT NULL,
  counterparty_iban TEXT DEFAULT NULL,
  counterparty_bic TEXT DEFAULT NULL,
  counterparty_bank TEXT DEFAULT NULL,

  notes TEXT DEFAULT NULL,
  file_name TEXT DEFAULT NULL,

  created_at DATETIME DEFAULT (datetime('now')),
  updated_at DATETIME DEFAULT (datetime('now')),

  FOREIGN KEY(invoice_id) REFERENCES invoices(id) ON DELETE CASCADE,
  FOREIGN KEY(customer_id) REFERENCES customers(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_payments_invoice_id ON payments(invoice_id);

CREATE TRIGGER IF NOT EXISTS trg_payments_updated_at
AFTER UPDATE ON payments
BEGIN
  UPDATE payments SET updated_at = datetime('now') WHERE id = NEW.id;
END;


-- reminders
CREATE TABLE IF NOT EXISTS reminders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,

  invoice_id INTEGER NOT NULL,
  customer_id INTEGER NOT NULL,

  invoice_snapshot TEXT NOT NULL DEFAULT '{}',

  is_sent INTEGER NOT NULL DEFAULT 0,
  is_cancelled INTEGER NOT NULL DEFAULT 0,

  level INTEGER NOT NULL DEFAULT 0,
  level_text TEXT DEFAULT NULL,

  reminder_date TEXT DEFAULT NULL,
  due_date_new TEXT DEFAULT NULL,

  reminder_fee REAL NOT NULL DEFAULT 0,
  late_interest REAL NOT NULL DEFAULT 0,

  intro_text TEXT DEFAULT NULL,
  warning_text TEXT DEFAULT NULL,
  closing_text TEXT DEFAULT NULL,

  sent_at TEXT DEFAULT NULL,
  sent_method TEXT DEFAULT NULL,

  proof_type TEXT DEFAULT NULL,
  proof_file_name TEXT DEFAULT NULL,
  proof_sent_at TEXT DEFAULT NULL,

  created_at DATETIME DEFAULT (datetime('now')),
  updated_at DATETIME DEFAULT (datetime('now')),

  FOREIGN KEY(invoice_id) REFERENCES invoices(id) ON DELETE CASCADE,
  FOREIGN KEY(customer_id) REFERENCES customers(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_reminders_invoice_id ON reminders(invoice_id);

CREATE TRIGGER IF NOT EXISTS trg_reminders_updated_at
AFTER UPDATE ON reminders
BEGIN
  UPDATE reminders SET updated_at = datetime('now') WHERE id = NEW.id;
END;


-- offers
CREATE TABLE IF NOT EXISTS offers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  customer_id INTEGER NOT NULL,

  date TEXT NOT NULL,
  valid_until TEXT DEFAULT NULL,

  customer_snapshot TEXT NOT NULL DEFAULT '{}',
  contact_person TEXT DEFAULT NULL,

  subject TEXT DEFAULT NULL,
  currency TEXT NOT NULL DEFAULT 'EUR.de-DE',
  payment_terms TEXT DEFAULT NULL,
  delivery_terms TEXT DEFAULT NULL,
  delivery_time TEXT DEFAULT NULL,

  positions TEXT NOT NULL DEFAULT '[]',
  net_total REAL NOT NULL DEFAULT 0,
  vat_total REAL NOT NULL DEFAULT 0,
  gross_total REAL NOT NULL DEFAULT 0,

  status TEXT NOT NULL DEFAULT 'draft',
  status_by TEXT DEFAULT NULL,
  status_date TEXT DEFAULT NULL,
  status_comments TEXT DEFAULT NULL,

  is_active INTEGER NOT NULL DEFAULT 1,
  is_legal INTEGER NOT NULL DEFAULT 0,

  introduction_text TEXT DEFAULT NULL,
  closing_text TEXT DEFAULT NULL,
  notes TEXT DEFAULT NULL,
  internal_notes TEXT DEFAULT NULL,

  created_at DATETIME DEFAULT (datetime('now')),
  updated_at DATETIME DEFAULT (datetime('now')),

  FOREIGN KEY(customer_id) REFERENCES customers(id) ON DELETE RESTRICT
);

CREATE INDEX IF NOT EXISTS idx_offers_customer_id ON offers(customer_id);

CREATE TRIGGER IF NOT EXISTS trg_offers_updated_at
AFTER UPDATE ON offers
BEGIN
  UPDATE offers SET updated_at = datetime('now') WHERE id = NEW.id;
END;


-- orders
CREATE TABLE IF NOT EXISTS orders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  customer_id INTEGER DEFAULT NULL,
  customer_snapshot TEXT DEFAULT '{}',

  date TEXT DEFAULT NULL,
  validity_date TEXT DEFAULT NULL,
  service_period_start TEXT DEFAULT NULL,
  service_period_end TEXT DEFAULT NULL,
  delivery_date TEXT DEFAULT NULL,

  status TEXT DEFAULT 'pending',
  status_date TEXT DEFAULT NULL,
  status_by TEXT DEFAULT NULL,
  status_comments TEXT DEFAULT NULL,

  is_active INTEGER DEFAULT 1,
  cancelled_at TEXT DEFAULT NULL,
  cancelled_by TEXT DEFAULT NULL,
  cancellation_reason TEXT DEFAULT NULL,

  delivery_terms TEXT DEFAULT NULL,
  delivery_address TEXT DEFAULT NULL,
  delivery_postal_code TEXT DEFAULT NULL,
  delivery_city TEXT DEFAULT NULL,
  delivery_country TEXT DEFAULT 'Deutschland',
  shipping_method TEXT DEFAULT NULL,

  payment_terms INTEGER DEFAULT 14,
  payment_method TEXT DEFAULT NULL,
  payment_conditions TEXT DEFAULT NULL,
  payment_reference TEXT DEFAULT NULL,
  currency TEXT DEFAULT 'EUR.de-DE',

  net_total REAL DEFAULT 0,
  vat_total REAL DEFAULT 0,
  gross_total REAL DEFAULT 0,

  positions TEXT DEFAULT '[]',
  customer_reference TEXT DEFAULT NULL,
  attachments TEXT DEFAULT '[]',

  priority TEXT DEFAULT NULL,
  internal_status_notes TEXT DEFAULT NULL,

  intro_text TEXT DEFAULT NULL,
  customer_notes TEXT DEFAULT NULL,
  internal_notes TEXT DEFAULT NULL,
  closing_text TEXT DEFAULT NULL,

  sent_at TEXT DEFAULT NULL,
  sent_method TEXT DEFAULT NULL,

  created_at DATETIME DEFAULT (datetime('now')),
  updated_at DATETIME DEFAULT (datetime('now')),

  FOREIGN KEY(customer_id) REFERENCES customers(id) ON DELETE RESTRICT
);

CREATE INDEX IF NOT EXISTS idx_orders_customer_id ON orders(customer_id);

CREATE TRIGGER IF NOT EXISTS trg_orders_updated_at
AFTER UPDATE ON orders
BEGIN
  UPDATE orders SET updated_at = datetime('now') WHERE id = NEW.id;
END;

-- End of schema
