
CREATE TABLE IF NOT EXISTS reminders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,

  invoice_id INTEGER NOT NULL,
  customer_id INTEGER NOT NULL,

  invoice_snapshot TEXT NOT NULL DEFAULT '{}',

  is_sent INTEGER NOT NULL DEFAULT 0,
  is_cancelled INTEGER NOT NULL DEFAULT 0,

  level INTEGER NOT NULL DEFAULT 0,
  level_text TEXT DEFAULT NULL,

  reminder_date TEXT DEFAULT NULL,
  due_date_new TEXT DEFAULT NULL,

  reminder_fee REAL NOT NULL DEFAULT 0,
  late_interest REAL NOT NULL DEFAULT 0,

  intro_text TEXT DEFAULT NULL,
  warning_text TEXT DEFAULT NULL,
  closing_text TEXT DEFAULT NULL,

  sent_at TEXT DEFAULT NULL,
  sent_method TEXT DEFAULT NULL,

  proof_type TEXT DEFAULT NULL,
  proof_file_name TEXT DEFAULT NULL,
  proof_sent_at TEXT DEFAULT NULL,

  created_at DATETIME DEFAULT (datetime('now')),
  updated_at DATETIME DEFAULT (datetime('now')),

  FOREIGN KEY(invoice_id) REFERENCES invoices(id) ON DELETE CASCADE,
  FOREIGN KEY(customer_id) REFERENCES customers(id) ON DELETE CASCADE
);


-- indexes --

CREATE INDEX IF NOT EXISTS idx_reminders_invoice_id ON reminders(invoice_id);
CREATE INDEX IF NOT EXISTS idx_reminders_customer_id ON reminders(customer_id);
CREATE INDEX IF NOT EXISTS idx_reminders_is_sent ON reminders(is_sent);
CREATE INDEX IF NOT EXISTS idx_reminders_is_cancelled ON reminders(is_cancelled);


-- trigger --

CREATE TRIGGER IF NOT EXISTS trg_reminders_updated_at
AFTER UPDATE ON reminders
BEGIN
  UPDATE reminders SET updated_at = datetime('now') WHERE id = NEW.id;
END;