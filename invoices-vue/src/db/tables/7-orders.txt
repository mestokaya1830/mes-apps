
CREATE TABLE IF NOT EXISTS orders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  customer_id INTEGER DEFAULT NULL,
  customer_snapshot TEXT DEFAULT '{}',

  date TEXT DEFAULT NULL,
  validity_date TEXT DEFAULT NULL,
  service_period_start TEXT DEFAULT NULL,
  service_period_end TEXT DEFAULT NULL,
  delivery_date TEXT DEFAULT NULL,

  status TEXT DEFAULT 'pending',
  status_date TEXT DEFAULT NULL,
  status_by TEXT DEFAULT NULL,
  status_comments TEXT DEFAULT NULL,

  is_active INTEGER DEFAULT 1,
  cancelled_at TEXT DEFAULT NULL,
  cancelled_by TEXT DEFAULT NULL,
  cancellation_reason TEXT DEFAULT NULL,

  delivery_terms TEXT DEFAULT NULL,
  delivery_address TEXT DEFAULT NULL,
  delivery_postal_code TEXT DEFAULT NULL,
  delivery_city TEXT DEFAULT NULL,
  delivery_country TEXT DEFAULT 'Deutschland',
  shipping_method TEXT DEFAULT NULL,

  payment_terms INTEGER DEFAULT 14,
  payment_method TEXT DEFAULT NULL,
  payment_conditions TEXT DEFAULT NULL,
  payment_reference TEXT DEFAULT NULL,
  currency TEXT DEFAULT 'EUR.de-DE',

  net_total REAL DEFAULT 0,
  vat_total REAL DEFAULT 0,
  gross_total REAL DEFAULT 0,

  positions TEXT DEFAULT '[]',
  customer_reference TEXT DEFAULT NULL,
  attachments TEXT DEFAULT '[]',

  priority TEXT DEFAULT NULL,
  internal_status_notes TEXT DEFAULT NULL,

  intro_text TEXT DEFAULT NULL,
  customer_notes TEXT DEFAULT NULL,
  internal_notes TEXT DEFAULT NULL,
  closing_text TEXT DEFAULT NULL,

  sent_at TEXT DEFAULT NULL,
  sent_method TEXT DEFAULT NULL,

  cancelled_at TEXT DEFAULT NULL,
  cancelled_by TEXT DEFAULT NULL,
  cancellation_reason TEXT DEFAULT NULL,

  created_at DATETIME DEFAULT (datetime('now')),
  updated_at DATETIME DEFAULT (datetime('now')),

  FOREIGN KEY(customer_id) REFERENCES customers(id) ON DELETE RESTRICT
);



-- indexes --

CREATE INDEX IF NOT EXISTS idx_orders_customer_id ON orders(customer_id);
CREATE INDEX IF NOT EXISTS idx_orders_status ON orders(status);
CREATE INDEX IF NOT EXISTS idx_orders_is_active ON orders(is_active);
CREATE INDEX IF NOT EXISTS idx_orders_date ON orders(date);


-- trigger --

CREATE TRIGGER IF NOT EXISTS trg_orders_updated_at
AFTER UPDATE ON orders
BEGIN
  UPDATE orders SET updated_at = datetime('now') WHERE id = NEW.id;
END;

