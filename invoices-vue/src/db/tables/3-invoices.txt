
CREATE TABLE IF NOT EXISTS invoices (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  is_active INTEGER NOT NULL DEFAULT 1,
  customer_id INTEGER NOT NULL,
  customer_snapshot TEXT NOT NULL DEFAULT '{}',


  service_date TEXT NOT NULL,
  date TEXT NOT NULL,
  due_date TEXT DEFAULT NULL,
  paid_at TEXT DEFAULT null,                        -- hier commt from payments create form

  currency TEXT NOT NULL DEFAULT 'EUR.de-DE',

  payment_terms INTEGER NOT NULL DEFAULT 14,
  payment_conditions TEXT DEFAULT NULL,

  early_payment_offer INTEGER NOT NULL DEFAULT 0,
  early_payment_discount REAL NOT NULL DEFAULT 0,
  early_payment_percentage REAL NOT NULL DEFAULT 0,
  early_payment_days INTEGER NOT NULL DEFAULT 0,
  early_payment_deadline TEXT DEFAULT NULL,              
  early_paid_discount_applied INTEGER DEFAULT 0,     -- hier commt from payments create form
  is_reminded INTEGER DEFAULT 0,                      -- hier commt from payments create form

  is_small_company INTEGER NOT NULL DEFAULT 0,
  is_reverse_charge INTEGER NOT NULL DEFAULT 0,
  is_eu_delivery INTEGER NOT NULL DEFAULT 0,

  positions TEXT NOT NULL DEFAULT '[]',

  net_total REAL NOT NULL DEFAULT 0,
  vat_total REAL NOT NULL DEFAULT 0,
  gross_total REAL NOT NULL DEFAULT 0,
  gross_total_after_discount REAL NOT NULL DEFAULT 0,

  payment_status TEXT NOT NULL DEFAULT 'unpaid',      -- hier commt from payments create form
  CHECK (payment_status IN ('unpaid','partially_paid','paid')),

  
  cancelled_at TEXT DEFAULT NULL,
  cancelled_by TEXT DEFAULT NULL,
  cancellation_reason TEXT DEFAULT NULL,

  created_at DATETIME DEFAULT (datetime('now')),
  updated_at DATETIME DEFAULT (datetime('now')),

  FOREIGN KEY(customer_id) REFERENCES customers(id) ON DELETE CASCADE
);


-- indexes --

CREATE INDEX IF NOT EXISTS idx_invoices_customer_status
ON invoices(customer_id, payment_status);

CREATE INDEX IF NOT EXISTS idx_invoices_payment_status
ON invoices(payment_status);

CREATE INDEX IF NOT EXISTS idx_invoices_due_date
ON invoices(due_date);

CREATE INDEX IF NOT EXISTS idx_invoices_early_payment_deadline
ON invoices(early_payment_deadline);

CREATE INDEX IF NOT EXISTS idx_invoices_date
ON invoices(date);

CREATE INDEX IF NOT EXISTS idx_invoices_paid_at
ON invoices(paid_at);


-- trigeger --

CREATE TRIGGER IF NOT EXISTS trg_invoices_updated_at
AFTER UPDATE ON invoices
BEGIN
  UPDATE invoices SET updated_at = datetime('now') WHERE id = NEW.id;
END;

